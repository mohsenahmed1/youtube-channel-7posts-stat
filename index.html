<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Channel Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>YouTube Channel Analyzer</h1>

    <div class="form-group">
        <label for="apiKey">Enter Your YouTube API Key:</label>
        <input type="text" id="apiKey" placeholder="Enter API Key">
    </div>
    <div class="form-group">
        <label for="channelId">Enter YouTube Channel Link:</label>
        <input type="text" id="channelId" placeholder="Enter Channel Link">
    </div>
    <button onclick="analyzeChannel()">Analyze</button>

    <h2>Video Metrics</h2>
    <div id="results"></div>

    <script>
        async function analyzeChannel() {
            const apiKey = document.getElementById('apiKey').value;
            const channelLink = document.getElementById('channelId').value;
            const channelId = extractChannelId(channelLink);

            if (!apiKey || !channelId) {
                alert('Please enter a valid API Key and Channel Link.');
                console.log("API Key or Channel ID is missing or invalid.");
                return;
            }

            try {
                const videos = await fetchVideos(apiKey, channelId);
                if (videos.length === 0) {
                    alert('No videos found.');
                    return;
                }

                const videoMetricsTable = generateVideoMetricsTable(videos);
                const engagementTable = generateEngagementTable(videos);

                document.getElementById('results').innerHTML = videoMetricsTable + engagementTable;
            } catch (error) {
                console.error("Error fetching videos:", error);
                alert("Error fetching data from YouTube. Please check your API key and try again.");
            }
        }

        function extractChannelId(link) {
            const regex = /channel\/(.*?)(\?|$)/;
            const match = link.match(regex);
            return match ? match[1] : null;
        }

        async function fetchVideos(apiKey, channelId) {
            const url = `https://www.googleapis.com/youtube/v3/search?key=${apiKey}&channelId=${channelId}&part=snippet&type=video&order=date&maxResults=7`;
            const response = await fetch(url);
            const data = await response.json();
            return data.items || [];
        }

        function generateVideoMetricsTable(videos) {
            let table = '<table>';
            table += '<tr><th>Current Month</th><th>Release Month</th><th>Conversion Ratio</th><th>Adjusted Views</th><th>Views</th></tr>';

            const currentMonth = new Date().toISOString().slice(0, 7);
            videos.forEach((video, index) => {
                const releaseDate = video.snippet.publishedAt.slice(0, 7);
                const conversionRatio = calculateConversionRatio(currentMonth, releaseDate);
                const adjustedViews = Math.round(video.statistics.viewCount * parseFloat(conversionRatio) / 100);

                table += `<tr>
                    <td>${currentMonth}</td>
                    <td>${releaseDate}</td>
                    <td>${conversionRatio}</td>
                    <td>${adjustedViews}</td>
                    <td>${video.statistics.viewCount}</td>
                </tr>`;
            });

            table += '</table>';
            return table;
        }

        function generateEngagementTable(videos) {
            let table = '<table>';
            table += '<tr><th>Post</th><th>Likes</th><th>Comments</th><th>Shares</th><th>Total</th><th>Average Engagement</th></tr>';

            let totalEngagement = 0;
            videos.forEach((video, index) => {
                const likes = parseInt(video.statistics.likeCount);
                const comments = parseInt(video.statistics.commentCount);
                const shares = parseInt(video.statistics.favoriteCount || 0);
                const total = likes + comments + shares;
                totalEngagement += total;

                table += `<tr>
                    <td>${index + 1}</td>
                    <td>${likes}</td>
                    <td>${comments}</td>
                    <td>${shares}</td>
                    <td>${total}</td>
                    <td>${totalEngagement / (index + 1)}</td>
                </tr>`;
            });

            table += '</table>';
            return table;
        }

        function calculateConversionRatio(currentMonth, releaseMonth) {
            if (currentMonth === releaseMonth) return '100%';
            if (currentMonth === shiftMonth(releaseMonth, 1)) return '90%';
            if (currentMonth === shiftMonth(releaseMonth, 2)) return '80%';
            return '70%';
        }

        function shiftMonth(month, shift) {
            const [year, monthNum] = month.split('-').map(Number);
            const newDate = new Date(year, monthNum - 1 - shift);
            return newDate.toISOString().slice(0, 7);
        }
    </script>
</body>
</html>
