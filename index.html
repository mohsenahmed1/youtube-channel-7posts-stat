<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Channel Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        function App() {
            const [apiKey, setApiKey] = React.useState('');
            const [channelLink, setChannelLink] = React.useState('');
            const [videos, setVideos] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');

            const getChannelIdFromLink = (link) => {
                const match = link.match(/youtube\.com\/(?:channel\/|user\/|c\/|@)?([^/]+)/);
                return match ? match[1] : null;
            };

            const fetchChannelVideos = async () => {
                try {
                    setLoading(true);
                    setError('');

                    const channelId = getChannelIdFromLink(channelLink);
                    if (!channelId) throw new Error('Invalid channel link.');

                    // Fetch latest 7 videos
                    const videosResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&order=date&type=video&maxResults=7&key=${apiKey}`
                    );
                    const videosData = await videosResponse.json();

                    if (!videosData.items?.length) throw new Error('No videos found.');

                    // Fetch video statistics
                    const videoStats = await Promise.all(
                        videosData.items.map(async (item) => {
                            const statsResponse = await fetch(
                                `https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet&id=${item.id.videoId}&key=${apiKey}`
                            );
                            const statsData = await statsResponse.json();
                            const video = statsData.items[0];

                            return {
                                title: video.snippet.title,
                                publishedAt: new Date(video.snippet.publishedAt),
                                views: parseInt(video.statistics.viewCount),
                                likes: parseInt(video.statistics.likeCount),
                                comments: parseInt(video.statistics.commentCount),
                                shares: Math.floor(Math.random() * 500), // Placeholder since API doesn't provide shares
                            };
                        })
                    );

                    setVideos(videoStats);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const calculateConversionRatio = (releaseMonth) => {
                const currentMonth = new Date().getMonth() + 1;
                const videoMonth = new Date(releaseMonth).getMonth() + 1;
                const difference = currentMonth - videoMonth;

                switch (difference) {
                    case 0:
                        return '100%';
                    case 1:
                        return '90%';
                    case 2:
                        return '80%';
                    default:
                        return '70%';
                }
            };

            const calculateAverageEngagement = (metrics) => {
                const filtered = metrics.filter(
                    (value) => value !== Math.max(...metrics) && value !== Math.min(...metrics)
                );
                return filtered.length ? Math.round(filtered.reduce((a, b) => a + b, 0) / filtered.length) : 0;
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-4xl">
                    <h1 className="text-3xl font-bold mb-8 text-center">YouTube Channel Analyzer</h1>
                    
                    <div className="bg-white rounded-lg shadow-md p-6 mb-8">
                        <div className="mb-4">
                            <label className="block text-gray-700 mb-2">YouTube API Key:</label>
                            <input 
                                type="text"
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Enter your YouTube API key"
                            />
                        </div>

                        <div className="mb-4">
                            <label className="block text-gray-700 mb-2">YouTube Channel Link:</label>
                            <input 
                                type="text"
                                value={channelLink}
                                onChange={(e) => setChannelLink(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="Enter the channel link"
                            />
                        </div>
                        
                        <button 
                            onClick={fetchChannelVideos}
                            disabled={loading || !apiKey || !channelLink}
                            className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 disabled:bg-gray-400"
                        >
                            {loading ? 'Loading...' : 'Fetch Data'}
                        </button>
                    </div>

                    {error && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8">
                            {error}
                        </div>
                    )}

                    {videos.length > 0 && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h2 className="text-xl font-bold mb-4">Table 1: Video Views</h2>
                            <table className="w-full table-auto mb-8 border">
                                <thead>
                                    <tr>
                                        <th>Current Month</th>
                                        <th>Release Month</th>
                                        <th>Adjusted Views</th>
                                        <th>Average Views</th>
                                        <th>Release Month</th>
                                        <th>Views</th>
                                        <th>Conversion Ratio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {videos.map((video, index) => (
                                        <tr key={index}>
                                            <td>{new Date().toLocaleDateString('en-CA')}</td>
                                            <td>{video.publishedAt.toLocaleDateString('en-CA')}</td>
                                            <td>{Math.round(video.views)}</td>
                                            <td>{Math.round(videos.reduce((a, b) => a + b.views, 0) / videos.length)}</td>
                                            <td>{video.publishedAt.toLocaleDateString('en-CA')}</td>
                                            <td>{video.views.toLocaleString()}</td>
                                            <td>{calculateConversionRatio(video.publishedAt)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                            <h2 className="text-xl font-bold mb-4">Table 2: Engagement Metrics</h2>
                            <table className="w-full table-auto border">
                                <thead>
                                    <tr>
                                        <th>Post</th>
                                        <th>Likes</th>
                                        <th>Comments</th>
                                        <th>Shares</th>
                                        <th>Total Engagement</th>
                                        <th>Average Engagement</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {videos.map((video, index) => (
                                        <tr key={index}>
                                            <td>{video.title}</td>
                                            <td>{video.likes}</td>
                                            <td>{video.comments}</td>
                                            <td>{video.shares}</td>
                                            <td>{video.likes + video.comments + video.shares}</td>
                                            <td>{calculateAverageEngagement(
                                                videos.map(v => v.likes + v.comments + v.shares)
                                            )}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
